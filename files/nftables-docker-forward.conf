# nftables configuration for host firewall with Docker
# Use with: sudo nft -f /etc/nftables-docker.conf
# Or copy the "forward" chain rules into your existing inet filter setup.
#
# Requirements:
#   - Table "inet filter" with chain "forward" must exist.
#   - Rule order is critical: all ACCEPT rules before the final DROP.
#
# This allows:
#   - Loopback, established/related, and your allowed TCP ports (input).
#   - Docker bridge traffic both ways (forward): from containers (iifname docker0/br-*)
#     and to containers (oifname docker0/br-*), including NAT return traffic (ping, DNS).
#   - Outbound via your uplink (e.g. br0) and return traffic via the same interface.

# Flush and define only the forward chain to avoid touching your input/output.
# If you prefer a full table, uncomment the "table inet filter" block below and
# adjust to your existing input/output/forward rules.

# --- Option A: Add/ensure only FORWARD rules (table and chain already exist) ---
# Run these in order. If your forward chain has a "drop" at the start, remove it first.

# 1. Remove any "drop" that appears before accept rules (so it can be re-added last)
#    List handles:  sudo nft -a list chain inet filter forward
#    Then:          sudo nft delete rule inet filter forward handle <handle>

# 2. Flush forward so we can build it cleanly (optional; only if you want a clean slate)
#    sudo nft flush chain inet filter forward

# 3. Add accept rules first (order matters for readability; all accept before drop)
#    Traffic from Docker bridges (container -> internet)
add rule inet filter forward iifname "docker0" accept
add rule inet filter forward iifname "br-*" accept
#    Traffic to Docker bridges (internet -> container, e.g. ping/DNS replies)
add rule inet filter forward oifname "docker0" accept
add rule inet filter forward oifname "br-*" accept
#    If your default route uses br0 (host uplink), allow forward to/from br0
add rule inet filter forward oifname "br0" accept
add rule inet filter forward iifname "br0" accept
# 4. Drop everything else
add rule inet filter forward drop

# --- Option B: Full table inet filter (example; adapt input/output to your needs) ---
# Uncomment and adapt if you want a single file that defines the whole table.

# table inet filter {
#     set allowed_tcp_ports {
#         type inet_service
#         elements = { 80, 443, 45100 }
#     }
#
#     chain input {
#         type filter hook input priority filter; policy accept;
#         iif "lo" accept
#         ct state established,related accept
#         tcp dport @allowed_tcp_ports accept
#         drop
#     }
#
#     chain output {
#         type filter hook output priority filter; policy accept;
#         accept
#     }
#
#     chain forward {
#         type filter hook forward priority filter; policy accept;
#         iifname "docker0" accept
#         iifname "br-*" accept
#         oifname "docker0" accept
#         oifname "br-*" accept
#         oifname "br0" accept
#         iifname "br0" accept
#         iifname "br-*" oifname "br0" accept
#         drop
#     }
# }
