#SPDX-License-Identifier: MIT-0
---
# tasks file for ansible-role-nftables

- name: Install nftables packages
  community.general.pacman:
    name:
      - iptables-nft
      - nftables
    state: present
  register: nftables_packages_install

- name: Confirm nftables packages are installed
  ansible.builtin.command: pacman -Q iptables-nft nftables
  register: nftables_packages_check
  changed_when: false
  failed_when: nftables_packages_check.rc != 0

- name: Deploy server nftables config (THEMIS)
  ansible.builtin.copy:
    src: server.conf
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: '0644'
  when: nftables_hostname == 'THEMIS'
  tags:
    - nftables
    - config

- name: Ensure nftables systemd drop-in directory exists (THEMIS)
  ansible.builtin.file:
    path: /etc/systemd/system/nftables.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  when: nftables_hostname == 'THEMIS'
  tags:
    - nftables
    - config
    - systemd

- name: Deploy nftables systemd override to preserve Docker rules (THEMIS)
  ansible.builtin.copy:
    dest: /etc/systemd/system/nftables.service.d/docker-preserve.conf
    content: |
      [Service]
      ExecStart=
      ExecStart=/bin/sh -c 'nft delete table inet filter 2>/dev/null; exec /usr/sbin/nft -f /etc/nftables.conf'
    owner: root
    group: root
    mode: '0644'
  when: nftables_hostname == 'THEMIS'
  notify: reload systemd
  tags:
    - nftables
    - config
    - systemd

- name: Deploy workstation nftables config (non-THEMIS)
  ansible.builtin.copy:
    src: workstation.conf
    dest: /etc/nftables.conf
    owner: root
    group: root
    mode: '0644'
  when: nftables_hostname != 'THEMIS'
  tags:
    - nftables
    - config

- name: Enable nftables.service (do not start)
  ansible.builtin.systemd:
    name: nftables
    enabled: true
    state: stopped
  when: (nftables_packages_check.rc | default(0)) == 0
  tags:
    - nftables
    - systemd
